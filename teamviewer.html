<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR TeamView v2.01</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --blue:#1769ff; --bg:#f6f8fb; --card:#fff; --muted:#6b7684; --chip-bg:#f1f5fb; --chip-bd:#e4ecf7 }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:980px;margin:20px auto;padding:0 14px 64px}
  header{display:flex;justify-content:space-between;align-items:center;margin:8px 0 14px}
  h1{font-size:18px;margin:0}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{padding:8px 12px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer}
  .btn.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
  .btn.ghost{background:#fff;color:#334155;border-color:#e6ecf5}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 28px rgba(23,105,255,.08);padding:14px;margin-top:14px}
  .muted{color:var(--muted);font-size:12px}
  .row{display:grid;gap:10px}
  @media(min-width:720px){ .row-2{grid-template-columns:1.2fr 1fr} }
  .kvs{display:grid;grid-template-columns:120px 1fr;gap:6px;font-size:14px}
  .kv-k{color:#6b7280;align-self:center}
  .kv-v{align-self:center}
  .kv-chip{display:inline-block;max-width:100%;padding:6px 10px;border-radius:999px;border:1px solid var(--chip-bd);background:var(--chip-bg);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .badge{display:inline-block;font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid #e2e8f0;background:#f1f5fb;color:#334155}
  .jersey{display:inline-flex;align-items:center;gap:6px}
  /* table */
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0 8px;table-layout:fixed}
  thead th{position:sticky;top:0;background:var(--bg);z-index:1}
  th{font-size:12px;color:#5b6472;text-align:left;padding:0 10px;user-select:none;cursor:pointer}
  th.sortable:hover{opacity:.85}
  td{background:#fff;padding:10px;border-top:1px solid #eef2f7;border-bottom:1px solid #eef2f7;vertical-align:top}
  tr td:first-child{border-left:1px solid #eef2f7;border-radius:12px 0 0 12px}
  tr td:last-child{border-right:1px solid #eef2f7;border-radius:0 12px 12px 0}
  .ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .center{display:flex;justify-content:center;align-items:center}
  .skeleton{background:linear-gradient(90deg,#f2f4f7,#e9eef7,#f2f4f7) 0 0/200px 100% no-repeat;animation:sh 1.2s infinite}
  .skeleton-pill{height:24px;border-radius:999px;display:inline-block}
  @keyframes sh{0%{background-position:-200px 0}100%{background-position:200px 0}}
  /* mobile-friendly column visibility */
  @media (max-width: 640px) {
    .col-pos, .col-elite, .col-age, .col-birth { display:none; }
  }
  /* print */
  @media print{
    header,.toolbar{display:none !important}
    body{background:#fff}
    .card{box-shadow:none;border:1px solid #e5e7eb}
  }
  .small{font-size:11px;color:#6b7280}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1 id="pageTitle">TeamView</h1>
    <div class="toolbar">
      <button class="btn" id="btnCSV">CSV 내보내기</button>
      <button class="btn" id="btnShare">공유</button>
      <button class="btn" id="btnCopy">링크 복사</button>
      <button class="btn" id="btnPrint">인쇄</button>
      <button class="btn" id="btnReload">새로고침</button>
    </div>
  </header>

  <div class="card" id="teamCard">
    <div class="row row-2">
      <div>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <div id="teamTitle" style="font-size:18px;font-weight:700">팀 정보를 불러오는 중…</div>
          <span class="badge" id="tourNameBadge"></span>
        </div>
        <div class="muted" id="teamSub" style="margin-top:4px">
          Team ID: <span id="teamIdTxt" style="cursor:pointer;text-decoration:underline dotted">-</span>
        </div>
        <div id="jerseys" class="jersey" style="margin-top:8px"></div>
        <div class="small" id="lastUpdated" style="margin-top:6px"></div>
      </div>
      <div>
        <div class="kvs" id="teamKVs">
          <div class="kv-k">지역</div>
          <div class="kv-v"><span id="kvRegion" class="kv-chip skeleton skeleton-pill" style="width:60%"></span></div>

          <div class="kv-k">종별·디비전</div>
          <div class="kv-v"><span id="kvCatDiv" class="kv-chip skeleton skeleton-pill" style="width:50%"></span></div>

          <div class="kv-k">대표자</div>
          <div class="kv-v"><span id="kvManager" class="kv-chip skeleton skeleton-pill" style="width:70%"></span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card" id="playersCard">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0;font-size:16px">선수 명단</h3>
      <div class="muted" id="countInfo"></div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="sortable" data-key="no" style="width:80px">등번호</th>
            <th class="sortable" data-key="name">선수이름</th>
            <th class="sortable col-pos" data-key="pos" style="width:100px">포지션</th>
            <th class="sortable col-birth" data-key="birth" style="width:140px">생년월일</th>
            <th class="sortable col-age" data-key="age" style="width:80px">만나이</th>
            <th class="sortable col-elite" data-key="elite" style="width:100px">선출</th>
          </tr>
        </thead>
        <tbody id="playersTbody">
          <tr><td colspan="6" class="center"><div class="skeleton" style="width:60%;height:16px;border-radius:8px"></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card" id="errorCard" style="display:none">
    <div style="color:#b91c1c;font-weight:700">불러오기 실패</div>
    <div class="muted" id="errorMsg" style="margin-top:6px"></div>
  </div>
</div>

<script>
/* =========================================================
 * BDR TeamView v2.01
 * - 병렬 로딩(Promise.all) + 재시도/타임아웃(네트워크 안정화)
 * - 안전 렌더링(esc) + 정렬(헤더 클릭) + CSV 내보내기
 * - ?appUrl=... 로 백엔드 즉시 교체 + localStorage 저장
 * ========================================================= */

/* ============ 상수/설정 ============ */
const DEFAULT_WEB_APP_URL='https://script.google.com/macros/s/AKfycbxxccpp-6Cwef-rphqjRYC-OHLmjaL8M9koCk50E4UDdKUtXEsKyEOCzP07EbmHW7CQMg/exec';
const CONF_KEY='BDR_ADMIN_CONF_V2';
const conf = (()=>{ try{ return JSON.parse(localStorage.getItem(CONF_KEY)||'{}'); }catch{return{};} })();
const urlParams = new URLSearchParams(location.search);
const overrideAppUrl = urlParams.get('appUrl');
if (overrideAppUrl) {
  conf.appUrl = overrideAppUrl;
  try{ localStorage.setItem(CONF_KEY, JSON.stringify(conf)); }catch{}
}
function validWebAppUrl(u){ return /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec(\?.*)?$/i.test((u||'').trim()); }
function apiBase(){ return validWebAppUrl(conf.appUrl)? conf.appUrl : DEFAULT_WEB_APP_URL; }
function apiUrl(path, q={}){ const u=new URL(apiBase()); u.searchParams.set('path', path); Object.entries(q).forEach(([k,v])=>u.searchParams.set(k,v)); return u.toString(); }

/* ============ 네트워크 유틸 (타임아웃 + 재시도) ============ */
async function fetchWithTimeout(url, opt={}, timeoutMs=12000){
  const ctrl=new AbortController();
  const t=setTimeout(()=>ctrl.abort('timeout'), timeoutMs);
  try{
    const res=await fetch(url,{...opt,signal:ctrl.signal,cache:'no-store',mode:'cors',credentials:'omit',redirect:'follow'});
    return res;
  }finally{ clearTimeout(t); }
}

async function getJSON(u, retries=2){
  let lastErr=null;
  for (let i=0;i<=retries;i++){
    try{
      const r=await fetchWithTimeout(u,{},12000);
      const text=await r.text();
      try{
        const data=JSON.parse(text);
        return data;
      }catch{
        return {ok:false,error:'JSON 파싱 실패', raw:text.slice(0,280)};
      }
    }catch(e){
      lastErr=e && e.message || String(e);
      await new Promise(r=>setTimeout(r, 400*(i+1))); // 점증 대기
    }
  }
  return {ok:false,error:lastErr||'네트워크 오류'};
}

/* ============ 공용 유틸 ============ */
const $=s=>document.querySelector(s);
const pad=n=>String(n).padStart(2,'0');
function esc(v){ return String(v??'').replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }
function phonePretty(s){ return String(s||'').replace(/\D/g,'').replace(/^(\d{3})(\d{3,4})(\d{4})$/,'$1-$2-$3'); }
function jerseySVG(hex,label){
  const color=(/^[#][0-9a-f]{6}$/i).test(hex||'')?hex:'#e5e7eb'; const text=(label||'').toUpperCase();
  return `<svg width="42" height="52" viewBox="0 0 42 52" xmlns="http://www.w3.org/2000/svg" aria-label="${esc(text)}">
    <g filter="url(#s)"><path d="M14 3 l4 6 h6 l4-6 h6 v15 l3 3 v27 a3 3 0 0 1 -3 3 h-26 a3 3 0 0 1 -3 -3 v-27 l3-3 v-15 z" fill="${color}" stroke="#cbd5e1"/>
    <text x="21" y="31" font-family="system-ui,sans-serif" font-size="9" fill="#0f172a" text-anchor="middle" font-weight="700">${esc(text)}</text></g>
    <defs><filter id="s" x="0" y="0" width="42" height="52"><feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="#000" flood-opacity=".08"/></filter></defs>
  </svg>`;
}
function qs(k){ return new URLSearchParams(location.search).get(k)||''; }
function fmtBirth(s){
  if(!s) return '';
  const d=new Date(s);
  if(!isNaN(d)) return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  // 숫자8자리(yyyymmdd)도 대응
  const m=String(s).replace(/\D/g,'').match(/^(\d{4})(\d{2})(\d{2})$/);
  if(m) return `${m[1]}-${m[2]}-${m[3]}`;
  return String(s);
}

/* ============ 렌더러 ============ */
function fillKV(id, text){
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = text || '-';
  el.classList.remove('skeleton','skeleton-pill');
}

function renderTeamCard(team){
  if(!team){
    $('#teamTitle').textContent='팀 정보를 찾을 수 없습니다.';
    $('#tourNameBadge').textContent='';
    $('#teamSub').textContent='';
    $('#teamKVs').innerHTML='';
    return;
  }
  const title = [team.teamNameKo||'', team.teamNameEn?`(${team.teamNameEn})`:'' ].join(' ').trim();
  $('#pageTitle').textContent = title || 'TeamView';
  $('#teamTitle').textContent = title || '무명 팀';
  $('#tourNameBadge').textContent = team.tourName || '';
  $('#teamIdTxt').textContent = String(team.teamId||'-');
  $('#jerseys').innerHTML = `<div class="jersey">${jerseySVG(team.uniformHome||'#e5e7eb','HOME')}${jerseySVG(team.uniformAway||'#e5e7eb','AWAY')}</div>`;

  const region = [team.province||'', team.city||''].join(' ').trim() || (team.region||'');
  const catdiv = [team.category||'', team.division||''].filter(Boolean).join(' · ');
  const mgr = [team.managerName||'', phonePretty(team.managerPhone||'')].filter(Boolean).join(' · ');

  fillKV('kvRegion', region);
  fillKV('kvCatDiv', catdiv);
  fillKV('kvManager', mgr);
}

function normalizeRows(rows){
  return rows.map(r=>{
    const no = r['등번호'] ?? r.backNumber ?? '';
    const name = r['선수이름'] ?? r.playerName ?? '';
    const pos = (r['포지션'] ?? r.position ?? '').toString().toUpperCase();
    const birth = fmtBirth(r['생년월일'] ?? r.birth ?? r.dob ?? '');
    let age = r['만나이'] ?? r.age ?? '';
    // 생년월일이 있고 나이가 없으면 계산(만나이)
    if (!age && birth){
      const bd = new Date(birth);
      if(!isNaN(bd)){
        const today = new Date();
        age = today.getFullYear()-bd.getFullYear() - ((today.getMonth()<bd.getMonth() || (today.getMonth()===bd.getMonth() && today.getDate()<bd.getDate()))?1:0);
      }
    }
    const elite = r['선출여부'] ?? r.elite ?? '';
    return { no, name, pos, birth, age, elite };
  });
}

function renderPlayers(rows){
  const tb = $('#playersTbody');
  if(!Array.isArray(rows) || rows.length===0){
    tb.innerHTML = `<tr><td colspan="6" class="muted">등록된 선수 명단이 없습니다.</td></tr>`;
    $('#countInfo').textContent = '0명';
    return;
  }
  const safe = normalizeRows(rows);
  // 기본 정렬: 등번호(숫자 우선, 공백은 맨뒤)
  const normNo = v => {
    const s = String(v||'').trim();
    const m = s.match(/^\d+$/); return m ? parseInt(s,10) : Number.MAX_SAFE_INTEGER;
  };
  safe.sort((a,b)=> normNo(a.no) - normNo(b.no));

  tb.innerHTML = safe.map(r=>(
    `<tr>
      <td class="ellipsis" style="font-weight:700">${esc(r.no||'-')}</td>
      <td class="ellipsis">${esc(r.name||'')}</td>
      <td class="col-pos ellipsis">${esc(r.pos||'')}</td>
      <td class="col-birth ellipsis">${esc(r.birth||'')}</td>
      <td class="col-age ellipsis">${esc(r.age||'')}</td>
      <td class="col-elite ellipsis">${esc(r.elite||'')}</td>
    </tr>`
  )).join('');

  $('#countInfo').textContent = `${safe.length}명`;
  // 보관(정렬용/CSV용)
  window.__playersData = safe;
}

/* ============ 정렬 핸들러 ============ */
const sortState = { key:'no', dir:'asc' };
function applySort(key){
  const data = window.__playersData || [];
  if(!data.length) return;
  if(sortState.key===key){ sortState.dir = (sortState.dir==='asc'?'desc':'asc'); }
  else { sortState.key=key; sortState.dir='asc'; }
  const dir = sortState.dir==='asc'?1:-1;
  const cmp = (a,b)=>{
    const va=a[key], vb=b[key];
    if (key==='no'){ // 숫자 우선
      const na = /^\d+$/.test(String(va)) ? +va : Number.MAX_SAFE_INTEGER;
      const nb = /^\d+$/.test(String(vb)) ? +vb : Number.MAX_SAFE_INTEGER;
      if (na!==nb) return (na-nb)*dir;
    }
    const sa=String(va||'').toLowerCase(), sb=String(vb||'').toLowerCase();
    if (sa<sb) return -1*dir;
    if (sa>sb) return 1*dir;
    return 0;
  };
  data.sort(cmp);
  // 다시 렌더 (tbody만)
  const tb = $('#playersTbody');
  tb.innerHTML = data.map(r=>(
    `<tr>
      <td class="ellipsis" style="font-weight:700">${esc(r.no||'-')}</td>
      <td class="ellipsis">${esc(r.name||'')}</td>
      <td class="col-pos ellipsis">${esc(r.pos||'')}</td>
      <td class="col-birth ellipsis">${esc(r.birth||'')}</td>
      <td class="col-age ellipsis">${esc(r.age||'')}</td>
      <td class="col-elite ellipsis">${esc(r.elite||'')}</td>
    </tr>`
  )).join('');
}

/* ============ CSV 내보내기 ============ */
function toCSV(rows){
  const header = ['등번호','선수이름','포지션','생년월일','만나이','선출'];
  const lines = [header.join(',')].concat(
    rows.map(r=>[r.no,r.name,r.pos,r.birth,r.age,r.elite].map(v=>{
      const s = String(v??'');
      // 쉼표/따옴표/개행 처리
      if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }).join(','))
  );
  return '\uFEFF' + lines.join('\n'); // UTF-8 BOM
}
function downloadCSV(filename, content){
  const blob=new Blob([content],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=filename; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();}, 200);
}

/* ============ 로드 ============ */
async function boot(){
  const teamId = qs('teamId') || qs('id');
  if(!teamId){
    $('#errorCard').style.display='';
    $('#errorMsg').textContent='teamId 파라미터가 필요합니다. 예) teamview.html?teamId=TMXXXXXXXX';
    return;
  }

  // 병렬 요청
  const [teamRes, plyRes] = await Promise.all([
    getJSON(apiUrl('getteam', { teamId })),
    getJSON(apiUrl('players', { teamId }))
  ]);

  // 팀
  if(!(teamRes && (teamRes.ok===true || teamRes.team))){
    $('#errorCard').style.display='';
    $('#errorMsg').textContent = (teamRes && (teamRes.error||teamRes.raw)) || '팀 정보를 불러올 수 없습니다.';
  }
  renderTeamCard(teamRes && teamRes.team);

  // 선수
  if(!(plyRes && Array.isArray(plyRes.rows))){
    $('#playersTbody').innerHTML = `<tr><td colspan="6" class="muted">선수명단을 불러오지 못했습니다.</td></tr>`;
    $('#countInfo').textContent = '';
  }else{
    renderPlayers(plyRes.rows);
  }

  // 업데이트 시각
  const now = new Date();
  $('#lastUpdated').textContent = `업데이트: ${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
}

/* ============ 상단 버튼 ============ */
$('#btnReload').addEventListener('click', ()=>location.reload());
$('#btnPrint').addEventListener('click', ()=>window.print());
$('#btnCopy').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(location.href); alert('현재 페이지 링크를 복사했습니다.'); }catch{ alert('복사 실패'); }
});
$('#btnShare').addEventListener('click', async ()=>{
  try{
    if(navigator.share){
      await navigator.share({ title: document.title, text:'팀 선수명단', url: location.href });
    }else{
      await navigator.clipboard.writeText(location.href);
      alert('공유 API 미지원 기기입니다. 링크를 복사했습니다.');
    }
  }catch(e){}
});
$('#btnCSV').addEventListener('click', ()=>{
  const data = window.__playersData||[];
  if(!data.length){ alert('내보낼 선수 명단이 없습니다.'); return; }
  const team = $('#pageTitle').textContent || 'team';
  const csv = toCSV(data);
  downloadCSV(`${team}-players.csv`, csv);
});

// TeamID 클릭하면 복사
$('#teamIdTxt').addEventListener('click', async (e)=>{
  const id = e.target.textContent.trim();
  if(!id) return;
  try{ await navigator.clipboard.writeText(id); e.target.style.color='#1769ff'; setTimeout(()=>e.target.style.color='',800); }catch{}
});

/* ============ 헤더 정렬 이벤트 ============ */
document.querySelectorAll('th.sortable').forEach(th=>{
  th.addEventListener('click', ()=>{
    const key = th.getAttribute('data-key');
    if(key) applySort(key);
  });
});

boot();
</script>
</body>
</html>
